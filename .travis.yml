language: bash

matrix:
  include:
    - os: linux
      env: TARGET=android_armv7
    - os: linux
      env: TARGET=android_arm64
    - os: linux
      env: TARGET=android_x86
    - os: linux
      env: TARGET=android_x64
    - os: osx
      osx_image: xcode9.4
      env: TARGET=ios
    - os: osx
      osx_image: xcode8.3
      env: TARGET=macos
    - os: windows
      env: TARGET=win64

before_script:
- |
  if [[ $TARGET =~ ^android ]]; then
      pushd "$HOME" >/dev/null
      if [[ ! -e "android-ndk-r16b/source.properties" ]]; then
          curl --retry 10 -L http://dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip -O
          unzip -oq android-ndk-r16b-linux-x86_64.zip
          rm android-ndk-r16b-linux-x86_64.zip
      fi
      popd >/dev/null
      export ANDROID_NDK_r16b="$HOME/android-ndk-r16b"
  fi

script:
  - OPUSBUILD_BUILD_DIR=$PWD/build_static bash -x ./build.sh $TARGET static lib_static
  - OPUSBUILD_BUILD_DIR=$PWD/build_shared bash -x ./build.sh $TARGET shared lib_shared

before_deploy:
  - mkdir -p "binaries-${TARGET}-${TRAVIS_TAG}"
  - cp "libopus/COPYING" "binaries-${TARGET}-${TRAVIS_TAG}"
  - mv lib_static "binaries-${TARGET}-${TRAVIS_TAG}/static"
  - mv lib_shared "binaries-${TARGET}-${TRAVIS_TAG}/shared"
  - |
    if type zip >/dev/null 2>/dev/null; then
        zip "binaries-${TARGET}-${TRAVIS_TAG}.zip" -r "binaries-${TARGET}-${TRAVIS_TAG}"
    elif type 7z >/dev/null 2>/dev/null; then
        7z a -r "binaries-${TARGET}-${TRAVIS_TAG}.zip" "binaries-${TARGET}-${TRAVIS_TAG}"
    else
        echo 'Zip archiver not found.'
        exit 1
    fi

deploy:
  provider: releases
  api_key:
    secure: SXq+EROiRvT41Kz3/bVAqST/LMqbcfTwgEbPhMPYYpPrvEX7F3w1tQ8qceBZ3csMBkErmu/nZr5IgnZWgn1nIPvq9mqv83SYBUsEDf9gIMDTGdr9oHldaGM5bDZMdAPMYWtlSfd0JYZ4sHEj10LwWrHWR8cJzAkDL57aQ07HePd7qxaqIgSdXKocV4ORZHfzqxYSvGf+/0p0N3IwHMC11JJbAgB0xlrsfLjjICuxIxVCIvuK6UI+3+JWEj1XwfXN9yUZ5rM+q5mwmq35YwmXgddyh52XLYNafiKPngCGRCbGkU/k4CQBy4Iij0TxEUc3VQJoSh5MYg9jHqC+AxRKF71wV5A+0+WBDS9QcQGQe3N4s/7Sc/hBYa5/YdHEm9w26G6MnFQcK4tdowxGYmTcJMLeCCAwLfbE+V6QLFCCfPK9Rq61TK/JKlwmIbs8L6RwdSmaOUdZmaNc24b7YBiUWLg7/tiVgCRz8o8DtiMwf3u6BkH+WJyD0vYEkZRR5+9rHHldJSlTBbvIJKyEsMQcYpOShR4ZyE8mo9JLw4LmJdkzkJP3syo3i94+Xu5k76R01lRI+2WqZtEoGYT8bxwzpD0DtbV7izdju2byLxDyN9nPBPVMBO0eKoop6xpLbcxVG+b73Gk7Xh1zpernb+cMhO3w5eKnpD+O7PSUBh9jWQI=
  file: binaries-${TARGET}-${TRAVIS_TAG}.zip
  skip_cleanup: true
  on:
    repo: mezum/libopus_custom
    tags: true
